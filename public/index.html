<!-- public/index.html -->
<!DOCTYPE html>
<html lang="ta">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title data-translate="pageTitle">புகார் சமர்ப்பிப்பு</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            body {
                font-family: "Inter", sans-serif;
            }
            /* Toggle Switch Styles */
            .switch {
                position: relative;
                display: inline-block;
                width: 60px;
                height: 34px;
            }
            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: 0.4s;
                border-radius: 34px;
            }
            .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                transition: 0.4s;
                border-radius: 50%;
            }
            input:checked + .slider {
                background-color: #2196f3;
            }
            input:checked + .slider:before {
                transform: translateX(26px);
            }
        </style>
    </head>
    <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-lg">
            <!-- Language Toggle -->
            <div class="flex items-center justify-end mb-2">
                <span class="mr-2 font-medium text-gray-700">தமிழ்</span>
                <label class="switch">
                    <input type="checkbox" id="language-toggle" />
                    <span class="slider"></span>
                </label>
                <span class="ml-2 font-medium text-gray-700">English</span>
            </div>

            <div class="bg-white shadow-lg rounded-lg p-8">
                <h1
                    class="text-3xl font-bold text-center text-gray-800 mb-2"
                    data-translate="mainHeading"
                >
                    புகார் பெட்டி
                </h1>
                <p
                    class="text-center text-gray-600 mb-8"
                    data-translate="subHeading"
                >
                    உங்கள் புகார்களை இங்கே சமர்ப்பிக்கவும். குரல் அல்லது உரை
                    மூலம் சமர்ப்பிக்கலாம்.
                </p>

                <!-- Text Complaint Form -->
                <form id="text-complaint-form" class="mb-8">
                    <label
                        for="complaint-text"
                        class="block text-gray-700 text-sm font-bold mb-2"
                        data-translate="textLabel"
                        >உங்கள் புகாரை உள்ளிடவும்:</label
                    >
                    <textarea
                        id="complaint-text"
                        rows="4"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4"
                        required
                    ></textarea>
                    <button
                        type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                        data-translate="submitTextBtn"
                    >
                        உரை புகாரை சமர்ப்பிக்கவும்
                    </button>
                </form>

                <!-- Voice Complaint Section -->
                <div class="border-t pt-6">
                    <h2
                        class="text-xl font-semibold text-center text-gray-700 mb-4"
                        data-translate="voiceHeading"
                    >
                        அல்லது, ஒரு குரல் புகாரை பதிவு செய்யவும்
                    </h2>
                    <div class="flex items-center justify-center space-x-4">
                        <button
                            id="record-button"
                            class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-5 rounded-full flex items-center transition-transform transform hover:scale-105"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                                ></path>
                            </svg>
                            <span class="ml-2" data-translate="recordBtn"
                                >பதிவு</span
                            >
                        </button>
                        <button
                            id="stop-button"
                            class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-5 rounded-full flex items-center transition-transform transform hover:scale-105 hidden"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd"
                                ></path>
                            </svg>
                            <span class="ml-2" data-translate="stopBtn"
                                >நிறுத்து</span
                            >
                        </button>
                    </div>
                    <div id="audio-playback" class="mt-6 hidden">
                        <p
                            class="text-center font-medium mb-2"
                            data-translate="yourRecording"
                        >
                            உங்கள் பதிவு:
                        </p>
                        <audio
                            id="audio-player"
                            controls
                            class="w-full"
                        ></audio>
                        <button
                            id="submit-voice-button"
                            class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            data-translate="submitVoiceBtn"
                        >
                            குரல் புகாரை சமர்ப்பிக்கவும்
                        </button>
                    </div>
                </div>

                <p
                    id="status-message"
                    class="mt-6 text-center text-sm font-medium"
                ></p>
            </div>
        </div>

        <script>
            const translations = {
                ta: {
                    pageTitle: "புகார் சமர்ப்பிப்பு",
                    mainHeading: "புகார் பெட்டி",
                    subHeading:
                        "உங்கள் புகார்களை இங்கே சமர்ப்பிக்கவும். குரல் அல்லது உரை மூலம் சமர்ப்பிக்கலாம்.",
                    textLabel: "உங்கள் புகாரை உள்ளிடவும்:",
                    submitTextBtn: "உரை புகாரை சமர்ப்பிக்கவும்",
                    voiceHeading: "அல்லது, ஒரு குரல் புகாரை பதிவு செய்யவும்",
                    recordBtn: "பதிவு",
                    stopBtn: "நிறுத்து",
                    yourRecording: "உங்கள் பதிவு:",
                    submitVoiceBtn: "குரல் புகாரை சமர்ப்பிக்கவும்",
                    statusSubmitting: "சமர்ப்பிக்கப்படுகிறது...",
                    statusSuccess: "புகார் வெற்றிகரமாக சமர்ப்பிக்கப்பட்டது!",
                    statusFailed: "புகாரை சமர்ப்பிக்கத் தவறிவிட்டது.",
                    noEnterprise: "நிறுவன ஐடி காணவில்லை. URL செல்லுபடியாகாது.",
                    micError:
                        "மைக்ரோஃபோனை அணுக முடியவில்லை. தயவுசெய்து அனுமதிகளை சரிபார்க்கவும்.",
                },
                en: {
                    pageTitle: "Complaint Submission",
                    mainHeading: "Complaint Box",
                    subHeading:
                        "Submit your complaints here. You can submit via voice or text.",
                    textLabel: "Enter your complaint:",
                    submitTextBtn: "Submit Text Complaint",
                    voiceHeading: "Or, Record a Voice Complaint",
                    recordBtn: "Record",
                    stopBtn: "Stop",
                    yourRecording: "Your Recording:",
                    submitVoiceBtn: "Submit Voice Complaint",
                    statusSubmitting: "Submitting...",
                    statusSuccess: "Complaint submitted successfully!",
                    statusFailed: "Failed to submit complaint.",
                    noEnterprise:
                        "Enterprise ID is missing. The URL is invalid.",
                    micError:
                        "Could not access the microphone. Please check permissions.",
                },
            };

            document.addEventListener("DOMContentLoaded", () => {
                const languageToggle =
                    document.getElementById("language-toggle");
                let currentLang = "ta";

                const setLanguage = (lang) => {
                    currentLang = lang;
                    document.documentElement.lang = lang;
                    document
                        .querySelectorAll("[data-translate]")
                        .forEach((el) => {
                            const key = el.getAttribute("data-translate");
                            if (translations[lang][key]) {
                                el.innerText = translations[lang][key];
                            }
                        });
                    localStorage.setItem("language", lang);
                    languageToggle.checked = lang === "en";
                };

                languageToggle.addEventListener("change", (event) => {
                    setLanguage(event.target.checked ? "en" : "ta");
                });

                const savedLang = localStorage.getItem("language") || "ta";
                setLanguage(savedLang);

                const recordButton = document.getElementById("record-button");
                const stopButton = document.getElementById("stop-button");
                const audioPlayback = document.getElementById("audio-playback");
                const audioPlayer = document.getElementById("audio-player");
                const submitVoiceButton = document.getElementById(
                    "submit-voice-button"
                );
                const textComplaintForm = document.getElementById(
                    "text-complaint-form"
                );
                const statusMessage = document.getElementById("status-message");

                let mediaRecorder;
                let audioChunks = [];

                const params = new URLSearchParams(window.location.search);
                const enterpriseId = params.get("enterprise");

                if (!enterpriseId) {
                    statusMessage.textContent =
                        translations[currentLang].noEnterprise;
                    statusMessage.classList.add("text-red-500");
                    return;
                }

                // --- Text Complaint Submission ---
                textComplaintForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const complaintText =
                        document.getElementById("complaint-text").value;
                    statusMessage.textContent =
                        translations[currentLang].statusSubmitting;
                    statusMessage.classList.remove(
                        "text-green-500",
                        "text-red-500"
                    );

                    try {
                        const response = await fetch(
                            `/api/complaint-text/${enterpriseId}`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    complaint: complaintText,
                                }),
                            }
                        );
                        if (!response.ok) throw new Error("Server error");
                        statusMessage.textContent =
                            translations[currentLang].statusSuccess;
                        statusMessage.classList.add("text-green-500");
                        textComplaintForm.reset();
                    } catch (error) {
                        statusMessage.textContent =
                            translations[currentLang].statusFailed;
                        statusMessage.classList.add("text-red-500");
                    }
                });

                // --- Voice Complaint Logic ---
                recordButton.addEventListener("click", async () => {
                    try {
                        const stream =
                            await navigator.mediaDevices.getUserMedia({
                                audio: true,
                            });
                        mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();
                        audioChunks = [];

                        recordButton.classList.add("hidden");
                        stopButton.classList.remove("hidden");
                        audioPlayback.classList.add("hidden");

                        mediaRecorder.addEventListener(
                            "dataavailable",
                            (event) => {
                                audioChunks.push(event.data);
                            }
                        );

                        mediaRecorder.addEventListener("stop", () => {
                            const audioBlob = new Blob(audioChunks, {
                                type: "audio/webm",
                            });
                            const audioUrl = URL.createObjectURL(audioBlob);
                            audioPlayer.src = audioUrl;
                            audioPlayback.classList.remove("hidden");
                            stopButton.classList.add("hidden");
                            recordButton.classList.remove("hidden");
                        });
                    } catch (error) {
                        statusMessage.textContent =
                            translations[currentLang].micError;
                        statusMessage.classList.add("text-red-500");
                    }
                });

                stopButton.addEventListener("click", () => {
                    mediaRecorder.stop();
                });

                submitVoiceButton.addEventListener("click", async () => {
                    const audioBlob = new Blob(audioChunks, {
                        type: "audio/webm",
                    });
                    const formData = new FormData();
                    formData.append("complaint", audioBlob, "recording.webm");
                    statusMessage.textContent =
                        translations[currentLang].statusSubmitting;
                    statusMessage.classList.remove(
                        "text-green-500",
                        "text-red-500"
                    );

                    try {
                        const response = await fetch(
                            `/api/complaint-voice/${enterpriseId}`,
                            {
                                method: "POST",
                                body: formData,
                            }
                        );
                        if (!response.ok) throw new Error("Server error");
                        statusMessage.textContent =
                            translations[currentLang].statusSuccess;
                        statusMessage.classList.add("text-green-500");
                        audioPlayback.classList.add("hidden");
                    } catch (error) {
                        statusMessage.textContent =
                            translations[currentLang].statusFailed;
                        statusMessage.classList.add("text-red-500");
                    }
                });
            });
        </script>
    </body>
</html>
