<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin - View Complaints</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            body {
                font-family: "Inter", sans-serif;
            }
        </style>
    </head>
    <body class="bg-gray-100">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">
                    Complaint Dashboard
                </h1>
                <button
                    onclick="window.location.href='/'"
                    class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition"
                >
                    Go to Public Page
                </button>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="space-y-4" id="complaintsList">
                    <!-- Complaints will be loaded here -->
                    <p class="text-gray-500">Loading complaints...</p>
                </div>
            </div>
        </div>

        <script>
            async function fetchComplaints() {
                try {
                    const response = await fetch("/api/complaints");
                    if (response.status === 401) {
                        alert(
                            "Authentication failed. Please refresh and log in again."
                        );
                        return;
                    }
                    if (!response.ok) {
                        throw new Error(
                            `Failed to fetch complaints. Status: ${response.status}`
                        );
                    }
                    const complaints = await response.json();
                    displayComplaints(complaints);
                } catch (error) {
                    document.getElementById(
                        "complaintsList"
                    ).innerHTML = `<p class="text-red-500 font-semibold">Error: ${error.message}</p>`;
                }
            }

            function displayComplaints(complaints) {
                const list = document.getElementById("complaintsList");
                if (complaints.length === 0) {
                    list.innerHTML =
                        '<p class="text-gray-500">No complaints have been submitted yet.</p>';
                    return;
                }

                // Generate the HTML for each complaint
                list.innerHTML = complaints
                    .map((complaint) => {
                        let contentHtml = "";
                        // Explicitly check the type and generate the correct HTML
                        if (complaint.type === "voice" && complaint.filePath) {
                            contentHtml = `
                        <div class="mt-2">
                            <p class="font-medium text-gray-700 mb-1">Voice Complaint:</p>
                            <audio controls src="${complaint.filePath}" class="w-full sm:w-auto">
                                Your browser does not support the audio element.
                            </audio>
                        </div>`;
                        } else {
                            // Default to showing text, handles 'text' type
                            contentHtml = `<p class="text-gray-700 bg-gray-50 p-3 rounded-md break-words">${
                                complaint.complaint || "No text content."
                            }</p>`;
                        }

                        return `
                <div class="border border-gray-200 rounded-lg p-4 transition hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">Complaint #${complaint.id}</p>
                            <p class="text-sm text-gray-500 mb-3">Received on: ${complaint.timestamp}</p>
                            ${contentHtml}
                        </div>
                    </div>
                </div>`;
                    })
                    .join("");
            }

            // Fetch complaints when the page loads
            document.addEventListener("DOMContentLoaded", fetchComplaints);
        </script>
    </body>
</html>
