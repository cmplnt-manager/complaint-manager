<!DOCTYPE html>
<html lang="ta">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>நிர்வாகம் - புகார் மேலாண்மை</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            body {
                font-family: "Inter", sans-serif;
            }
            .complaint-item {
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                background-color: white;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
                    0 1px 2px 0 rgba(0, 0, 0, 0.06);
                transition: opacity 0.3s ease;
            }
            .complaint-item.resolved {
                opacity: 0.6;
                background-color: #f7fafc;
            }
            .complaint-item.resolved .content p {
                text-decoration: line-through;
            }
            .complaint-item .content {
                margin-bottom: 1rem;
            }
            .complaint-item .actions button {
                padding: 0.5rem 1rem;
                border-radius: 0.375rem;
                border: none;
                color: white;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }
            .btn-delete {
                background-color: #ef4444;
            }
            .btn-delete:hover {
                background-color: #dc2626;
            }
            .btn-resolve {
                background-color: #22c55e;
            }
            .btn-resolve:hover {
                background-color: #16a34a;
            }
            .btn-reopen {
                background-color: #f97316;
            }
            .btn-reopen:hover {
                background-color: #ea580c;
            }
            audio {
                width: 100%;
                margin-top: 0.5rem;
            }
        </style>
    </head>
    <body class="bg-gray-100 p-4 sm:p-8">
        <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                நிர்வாகி டாஷ்போர்டு
            </h1>
            <p class="text-gray-600 mb-6">
                சமர்ப்பிக்கப்பட்ட அனைத்து புகார்களும் கீழே பட்டியலிடப்பட்டுள்ளன.
            </p>
            <div id="complaint-list">
                <p>புகார்கள் ஏற்றப்படுகின்றன...</p>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", fetchComplaints);

            async function fetchComplaints() {
                try {
                    const response = await fetch("/api/complaints");
                    if (response.status === 401) {
                        alert(
                            "அங்கீகாரம் தோல்வியடைந்தது. தயவுசெய்து புதுப்பித்து சரியான சான்றுகளை உள்ளிடவும்."
                        );
                        return;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP பிழை! நிலை: ${response.status}`);
                    }
                    const complaints = await response.json();
                    displayComplaints(complaints);
                } catch (error) {
                    console.error("புகார்களைப் பெறுவதில் தோல்வி:", error);
                    document.getElementById("complaint-list").innerHTML =
                        '<p class="text-red-500">புகார்களை ஏற்ற முடியவில்லை.</p>';
                }
            }

            function displayComplaints(complaints) {
                const list = document.getElementById("complaint-list");
                list.innerHTML = "";

                if (complaints.length === 0) {
                    list.innerHTML =
                        "<p>இதுவரை எந்த புகாரும் சமர்ப்பிக்கப்படவில்லை.</p>";
                    return;
                }

                // 'தீர்வு' புகார்களை கீழே காட்ட வரிசைப்படுத்தவும்
                complaints.sort((a, b) => {
                    if (a.status === "resolved" && b.status !== "resolved")
                        return 1;
                    if (a.status !== "resolved" && b.status === "resolved")
                        return -1;
                    return b.id - a.id; // ஒரே நிலையில் உள்ள புகார்களுக்கு புதியதை முதலில் காட்டவும்
                });

                complaints.forEach((complaint) => {
                    const item = document.createElement("div");
                    item.className = "complaint-item";
                    item.id = `complaint-${complaint.id}`;
                    if (complaint.status === "resolved") {
                        item.classList.add("resolved");
                    }

                    let contentHtml = "";
                    if (complaint.type === "voice" && complaint.filepath) {
                        contentHtml = `
                        <p class="font-semibold">குரல் வழி புகார்:</p>
                        <audio controls src="${complaint.filepath}"></audio>
                    `;
                    } else {
                        contentHtml = `<p>${
                            complaint.complaint || "உரை உள்ளடக்கம் இல்லை."
                        }</p>`;
                    }

                    let resolveButtonHtml = "";
                    if (complaint.status === "open") {
                        resolveButtonHtml = `<button onclick="updateStatus(${complaint.id}, 'resolved')" class="btn-resolve">தீர்வு கண்டதாக குறி</button>`;
                    } else {
                        resolveButtonHtml = `<button onclick="updateStatus(${complaint.id}, 'open')" class="btn-reopen">மீண்டும் திற</button>`;
                    }

                    item.innerHTML = `
                    <div class="content">
                        <p class="text-sm text-gray-500 mb-2"><strong>ID:</strong> ${complaint.id} | <strong>பதிவு செய்யப்பட்டது:</strong> ${complaint.timestamp}</p>
                        ${contentHtml}
                    </div>
                    <div class="actions flex space-x-2">
                        <button onclick="deleteComplaint(${complaint.id})" class="btn-delete">நீக்கு</button>
                        ${resolveButtonHtml}
                    </div>
                `;
                    list.appendChild(item);
                });
            }

            async function deleteComplaint(id) {
                if (!confirm(`புகார் #${id} ஐ நீக்க விரும்புகிறீர்களா?`)) {
                    return;
                }
                try {
                    const response = await fetch(`/api/complaints/${id}`, {
                        method: "DELETE",
                    });
                    if (!response.ok) throw new Error("நீக்க முடியவில்லை.");
                    document.getElementById(`complaint-${id}`).remove();
                } catch (error) {
                    console.error("நீக்கும்போது பிழை:", error);
                    alert("புகாரை நீக்க முடியவில்லை.");
                }
            }

            async function updateStatus(id, status) {
                try {
                    const response = await fetch(
                        `/api/complaints/${id}/status`,
                        {
                            method: "PUT",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ status }),
                        }
                    );
                    if (!response.ok)
                        throw new Error("நிலையை புதுப்பிக்க முடியவில்லை.");
                    fetchComplaints(); // பட்டியலைப் புதுப்பித்து மறுசீரமைக்க
                } catch (error) {
                    console.error("நிலையை புதுப்பிக்கும்போது பிழை:", error);
                    alert("புகாரின் நிலையை புதுப்பிக்க முடியவில்லை.");
                }
            }
        </script>
    </body>
</html>
